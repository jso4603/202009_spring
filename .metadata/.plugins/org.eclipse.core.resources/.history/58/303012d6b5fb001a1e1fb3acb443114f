package com.myboard.service;

import java.util.HashMap;
import java.util.Map;

import javax.annotation.Resource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import com.myboard.dao.MemberDAO;
import com.myboard.dto.MemberDTO;

@Service
public class MemberServiceImpl implements MemberService {
	private static final Logger logger = LoggerFactory.getLogger(MemberServiceImpl.class);
	
	@Resource
	private BCryptPasswordEncoder encoder;
	
	@Resource
	private MemberDAO mdao;
	
	@Resource
	private BFileService fservice;

	// 회원 가입 
	@Transactional
	@Override
	public Map<String,Object> insert(MemberDTO mdto, MultipartFile photofile) throws Exception {
		String msg = null;
		//result : 0(회원가입 성공),1(회원가입 실패)
		int result = -1;
		
		//아이디 중복 체크
		MemberDTO rdto =mdao.selectOne(mdto.getUserid());
		
		if(rdto == null) { // 기존 아이디 미존재
			// 패스워드 암호화
			mdto.setPasswd(encoder.encode(mdto.getPasswd()));
			
			// 회원사진 저장하고 저장된 파일 이름
			String filename = fservice.fileUpload(photofile);
			mdto.setFilename(filename);
			logger.info("insert dto : "+mdto);
			
			mdao.insert(mdto);
			msg = "회원가입이 완료되었습니다.";
			result = 0;
		} else {
			msg = "중복된 아이디가 있습니다.";
			result = 1;
		}
		
		Map<String,Object> map = new HashMap<>();
		map.put("msg", msg);
		map.put("result", result);
		return map;
		
	}

	// 회원 수정 
	@Transactional
	@Override
	public void update(MemberDTO mdto) throws Exception {
		mdao.update(mdto);
	}

	// 회원 탈퇴
	@Transactional
	@Override
	public void delete(String userid) throws Exception {
		mdao.delete(userid);
	}

	// 로그인 체크
	@Override
	public Map<String, Object> loginCheck(String userid, String passwd) throws Exception {
		String msg = null;
		//result : 0(로그인성공),1(아이디미존재),2(패스워드불일치)
		int result = -1;
		
		MemberDTO mdto = mdao.selectOne(userid);		
		logger.debug("loginCheck id/pw : "+userid+"/"+passwd);

		if(mdto == null) {
			msg = "존재하지 않는 아이디입니다.";
			result = 1;	
		}else {
			if(encoder.matches(passwd, mdto.getPasswd())){
				msg = "로그인 성공";
				result = 0;
			} else {
				msg = "비밀번호가 다릅니다.";
				result = 2;
			}
		}
		
		Map<String, Object> map = new HashMap<>();
		map.put("msg", msg);
		map.put("result", result);
		return map;	
	}

	//수정 폼에 데이터 전송
	@Override
	public MemberDTO modify(String userid) throws Exception {
		// TODO Auto-generated method stub
		return null;
	}

}
